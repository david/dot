#!/usr/bin/env bash

set -euo pipefail

sys_path=$(realpath ${BASH_SOURCE[0]})

dir="$(dirname $sys_path)"
while [[ ! -d ${dir}/.git ]] ; do
  dir="$(dirname $dir)"
done

if [[ $dir == "/" ]] ; then
  >&2 echo "sys is not in a git repo"
  exit 1
fi

SYS_HOME=$dir

module="${1:-}"

if [[ -z "$module" ]] ; then
  >&2 echo "missing module argument"

  exit 1
fi

if [[ "$module" == "import" ]] ; then
  shift

  path=$(realpath $1)
  orig=$path

  if [[ ! -d "$path" ]] ; then
    >&2 echo "import only works for directories"
    exit 1
  fi

  path=$(echo $path | sed "s|$HOME/||")
  path=$(echo $path | sed "s/^\.//")

  dir=$(echo $path | xargs dirname)

  mkdir -p ${SYS_HOME}/${dir}

  mv $orig ${SYS_HOME}/${dir}
  ln -s ${SYS_HOME}/${dir}

  exit 0
fi

shift

module_script="${SYS_HOME}/scripts/sys.$module"

if [[ ! -x $module_script ]] ; then
  >&2 echo "module $(basename $module_script) not found"
  exit 1
fi

exec bash $module_script "$@"
