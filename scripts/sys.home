#!/usr/bin/env bash

set -euo pipefail

if [[ -v CONTAINER_ID ]] ; then
  SYS_ENV="boxes/${CONTAINER_ID}"
else
  SYS_ENV="hosts/${HOSTNAME}"
fi

script_dir="$(realpath $(dirname ${BASH_SOURCE[0]}))"
SYS_HOME="$(dirname $script_dir)"

cd $SYS_HOME

if [[ "${1:-}" != "sync" ]] ; then
  >&2 echo "usage: $0 sync"
  exit 1
fi

for x in ${SYS_HOME}/templates/shared/home/config/* ; do
  target="${HOME}/.config/$(basename $x)"

  if [[ -e $target && ! -h $target ]] ; then
    >&2 echo "Can't manage ${target}: target exists and is not a symlink"
    exit 1
  fi

  if [[ "$(basename $x)" == "bash" ]] ; then
    for y in ${x}/* ; do
      target="${HOME}/.$(basename $y)"

      if [[ -e $target && ! -h $target ]] ; then
        >&2 echo "Can't manage ${target}: target exists and is not a symlink"
        exit 1
      fi

      rm -f $target
      ln -s $y $target
    done
  else
    rm -f $target
    ln -s $x $target
  fi
done

mkdir -p ${HOME}/.local/share

# Collect local directories to process
SYS_LOCAL_DIRS=()

# Add box template local directory when in a container
if [[ -v CONTAINER_ID ]] ; then
  SYS_LOCAL_DIRS+=("${SYS_HOME}/templates/box/local")
fi

# Add environment-specific local directory
SYS_LOCAL_HOME="${SYS_HOME}/${SYS_ENV}/home/local"
if [[ -d ${SYS_LOCAL_HOME} ]] ; then
  SYS_LOCAL_DIRS+=("${SYS_LOCAL_HOME}")
fi

# Process all local directories
for SYS_LOCAL_DIR in "${SYS_LOCAL_DIRS[@]}" ; do
  if [[ ! -d "${SYS_LOCAL_DIR}" ]] ; then
    continue
  fi

  while IFS= read -r -d '' x; do
    basepath=$(echo "$x" | sed -e "s#${SYS_LOCAL_DIR}/##")
    target="${HOME}/.local/${basepath}"

    mkdir -p "$(dirname $target)"

    if [[ ! -e "$target" ]] ; then
      if [[ -d "$x" ]] ; then
        mkdir -p "$target"
      elif [[ -f "$x" ]] ; then
        ln -s "$x" "$target"
      else
        >&2 echo "Don't know what to do with $x"
        exit 1
      fi
    elif [[ -d "$x" && -d "$target" ]] ; then
      continue
    elif [[ -f "$x" && -h "$target" ]] ; then
      ln -sf "$x" "$target"
    else
      >&2 echo "Can't manage ${target}"
      exit 1
    fi
  done < <(find "$SYS_LOCAL_DIR" -type f -print0)
done
